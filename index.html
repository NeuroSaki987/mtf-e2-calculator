âš ï¸æ³¨æ„ï¼šæœ¬è®¡ç®—ä»…è®¡ç®—è¡€è¯æµ“åº¦ï¼Œå¹¶ä¸ä»£è¡¨æ€» E2ï¼ŒåŸºäºè¯ä»£åŠ¨åŠ›å­¦æ¨¡æ‹Ÿï¼Œç»“æœå¹¶ä¸å‡†ç¡®
<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>ğŸ¥E2æµ“åº¦è®¡ç®—å™¨</title>  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  

    <style>  
        body {  
            font-family: Arial, sans-serif;  
            max-width: 1600px;  
            margin: 0 auto;  
            padding: 20px;  
            background-color: #f5f5f5;  
        }  
        .container {  
            background: white;  
            padding: 30px;  
            border-radius: 10px;  
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);  
            margin-bottom: 20px;  
        }  
        .function-tabs {  
            display: flex;  
            margin-bottom: 20px;  
            border-bottom: 2px solid #eee;  
        }  
		.tab-button {  
			background: #F7A8B8;
			color: white;  
			border: none;  
			padding: 15px 30px;  
			cursor: pointer;  
			font-size: 16px;  
			font-weight: bold;  
			border-bottom: 3px solid transparent;  
			transition: all 0.3s;  
		}  
		.tab-button.active {  
			background: #F7A8B8;
			color: white;  
			border-bottom-color: #E67E94;
		}  
        .tab-content {  
            display: none;  
        }  
        .tab-content.active {  
            display: block;  
        }  
        .input-group {  
            display: flex;  
            gap: 20px;  
            margin-bottom: 20px;  
            flex-wrap: wrap;  
        }  
        .input-field {  
            flex: 1;  
            min-width: 200px;  
        }  
        label {  
            display: block;  
            margin-bottom: 5px;  
            font-weight: bold;  
            color: #333;  
        }  
        input, select {  
            width: 100%;  
            padding: 10px;  
            border: 2px solid #ddd;  
            border-radius: 5px;  
            font-size: 16px;  
        }  
        button {  
            background: #55CDFC;  
            color: white;  
            padding: 12px 30px;  
            border: none;  
            border-radius: 5px;  
            cursor: pointer;  
            font-size: 16px;  
            font-weight: bold;  
            transition: transform 0.2s;  
        }  
        button:hover {  
            transform: translateY(-2px);  
            background: #00B3E5;  
        }  
        .add-dose-btn {  
            background: #FFB6C1;  
        }  
        .add-dose-btn:hover {  
            background: #FF9FB3;  
        }  
        .remove-dose-btn {  
            background: #FFB6C1;  
        }  
        .remove-dose-btn:hover {  
            background: #FF9FB3;  
        }  
        .charts-container {  
            display: grid;  
            grid-template-columns: 1fr 1fr;  
            gap: 20px;  
            margin: 20px 0;  
        }  
        .chart-wrapper {  
            position: relative;  
            background: white;  
            padding: 15px;  
            border-radius: 8px;  
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);  
        }  
        .chart-container {  
            position: relative;  
            height: 400px;  
        }  
        .main-chart {  
            height: 500px;  
        }  
        .results-table {  
            width: 100%;  
            border-collapse: collapse;  
            margin: 20px 0;  
        }  
        .results-table th, .results-table td {  
            border: 1px solid #ddd;  
            padding: 8px;  
            text-align: center;  
        }  
        .results-table th {  
            background-color: #f2f2f2;  
            font-weight: bold;  
        }  
        .summary-box {  
            background: #55CDFC;  
            color: white;  
            padding: 20px;  
            border-radius: 10px;  
            margin: 20px 0;  
        }  
        .warning-box {  
            background: #fff3cd;  
            border: 1px solid #ffeaa7;  
            color: #856404;  
            padding: 15px;  
            border-radius: 5px;  
            margin: 20px 0;  
        }  
        .unit-toggle {  
            margin: 10px 0;  
        }  
        .unit-toggle button {  
            background: #55CDFC;  
            color: white;  
            border: 1px solid #ddd;  
            padding: 5px 15px;  
            margin-right: 5px;  
            font-size: 14px;  
        }  
        .unit-toggle button.active {  
            background: #0099CC;  
        }  
        .multi-dose-inputs {  
            display: grid;  
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));  
            gap: 15px;  
            margin: 15px 0;  
        }  
        .dose-time-input {  
            background: #f8f9fa;  
            padding: 15px;  
            border-radius: 8px;  
            border: 1px solid #dee2e6;  
        }  
        .dose-time-input label {  
            font-size: 14px;  
            margin-bottom: 8px;  
        }  
        .dose-time-input input {  
            margin-bottom: 8px;  
        }  
        .hourly-table-container {  
            overflow-x: auto;  
            margin: 20px 0;  
        }  
        .hourly-table {  
            min-width: 1000px;  
            font-size: 11px;  
        }  
        .hourly-table th, .hourly-table td {  
            padding: 3px 4px;  
            white-space: nowrap;  
        }  
        .dosing-markers {  
            position: absolute;  
            top: 10px;  
            right: 20px;  
            background: rgba(255,255,255,0.95);  
            padding: 12px;  
            border-radius: 8px;  
            font-size: 12px;  
            max-width: 250px;  
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);  
            z-index: 10;  
        }  
        @media (max-width: 1200px) {  
            .charts-container {  
                grid-template-columns: 1fr;  
            }  
        }  
    </style>
</head>  
<body>  
    <div class="container">  
        <h1>ğŸ¥ E2 æµ“åº¦è®¡ç®—å™¨</h1>  
          
        <div class="function-tabs">  
            <button class="tab-button active" onclick="switchTab('single')">å•æ¬¡ç»™è¯æ¨¡æ‹Ÿ</button>  
            <button class="tab-button" onclick="switchTab('multiple')">å¤šæ¬¡ç»™è¯æ¨¡æ‹Ÿ</button>  
        </div>  
  

        <div id="single-dose" class="tab-content active">  
            <div class="input-group">  
                <div class="input-field">  
                    <label for="weight">ä½“é‡ (kg):</label>  
                    <input type="number" id="weight" value="57" min="30" max="150" step="0.1">  
                </div>  
                <div class="input-field">  
                    <label for="dose">ç”¨è¯é‡ (mg):</label>  
                    <input type="number" id="dose" value="2" min="0.1" max="10" step="0.1">  
                </div>  
                <div class="input-field">  
                    <label for="bioavailability">ç”Ÿç‰©åˆ©ç”¨åº¦æ¨¡å¼:</label>  
                    <select id="bioavailability">  
                        <option value="theoretical">ç†è®ºæ¨¡å‹ (F=4%)</option>  
                        <option value="calibrated" selected>æ ¡å‡†æ¨¡å‹ (F=0.16%, å‚è€ƒæ–‡çŒ®Cmax)</option>  
                    </select>  
                </div>  
            </div>  
              
            <button onclick="calculateAndPlot()">è®¡ç®—</button>  
              
            <div class="unit-toggle">  
                <span><strong>æµ“åº¦å•ä½:</strong></span>  
                <button id="btn-pgml" class="active" onclick="toggleUnit('pgml')">pg/mL</button>  
                <button id="btn-pmol" onclick="toggleUnit('pmol')">pmol/L</button>  
            </div>  
        </div>  
  

        <div id="multiple-dose" class="tab-content">  
            <div class="input-group">  
                <div class="input-field">  
                    <label for="multi-weight">ä½“é‡ (kg):</label>  
                    <input type="number" id="multi-weight" value="57" min="30" max="150" step="0.1">  
                </div>  
                <div class="input-field">  
                    <label for="dose-per-time">æ¯æ¬¡ç”¨è¯é‡ (mg):</label>  
                    <input type="number" id="dose-per-time" value="2" min="0.1" max="10" step="0.1">  
                </div>  
                <div class="input-field">  
                    <label for="multi-bioavailability">ç”Ÿç‰©åˆ©ç”¨åº¦æ¨¡å¼:</label>  
                    <select id="multi-bioavailability">  
                        <option value="theoretical">ç†è®ºæ¨¡å‹ (F=4%)</option>  
                        <option value="calibrated" selected>æ ¡å‡†æ¨¡å‹ (F=0.16%, å‚è€ƒæ–‡çŒ®Cmax)</option>  
                    </select>  
                </div>  
            </div>  
  
            <h4>ç»™è¯æ—¶é—´:</h4>  
            <div id="dose-schedule" class="multi-dose-inputs">  
                <div class="dose-time-input">  
                    <label>ç¬¬1æ¬¡ç»™è¯:</label>  
                    <input type="number" class="dose-hour" value="0" min="0" max="240" step="0.5">  
                    <input type="number" class="dose-amount" value="2" min="0.1" max="10" step="0.1">  
                    <small>æ—¶é—´(h) | å‰‚é‡(mg)</small>  
                </div>  
                <div class="dose-time-input">  
                    <label>ç¬¬2æ¬¡ç»™è¯:</label>  
                    <input type="number" class="dose-hour" value="24" min="0" max="240" step="0.5">  
                    <input type="number" class="dose-amount" value="2" min="0.1" max="10" step="0.1">  
                    <small>æ—¶é—´(h) | å‰‚é‡(mg)</small>  
                </div>  
                <div class="dose-time-input">  
                    <label>ç¬¬3æ¬¡ç»™è¯:</label>  
                    <input type="number" class="dose-hour" value="48" min="0" max="240" step="0.5">  
                    <input type="number" class="dose-amount" value="2" min="0.1" max="10" step="0.1">  
                    <small>æ—¶é—´(h) | å‰‚é‡(mg)</small>  
                </div>  
            </div>  
              
            <button class="add-dose-btn" onclick="addDoseTime()">â• æ·»åŠ ç»™è¯æ—¶é—´</button>  
              
            <div style="margin: 20px 0;">  
                <button onclick="calculateMultipleDoses()">è®¡ç®—</button>  
                <label style="margin-left: 20px;">  
                    <input type="checkbox" id="show-steady-state" checked> æ˜¾ç¤ºç¨³æ€åˆ†æ  
                </label>  
            </div>  
        </div>  
    </div>  
  
    <div class="container">  
        <div id="summary" class="summary-box" style="display:none;">  
            <h3 id="summary-title">å¿«é€Ÿç»“è®º</h3>  
            <div id="summary-content"></div>  
        </div>   
        <div class="charts-container" id="charts-container">  
            <div class="chart-wrapper">  
                <h3>é›ŒäºŒé†‡(E2)è¡€è¯æµ“åº¦-æ—¶é—´æ›²çº¿</h3>  
                <div class="chart-container main-chart">  
                    <canvas id="concentrationChart"></canvas>  
                    <div id="dosing-markers" class="dosing-markers" style="display:none;"></div>  
                </div>  
            </div>  
              
            <div class="chart-wrapper">  
                <h3>25å°æ—¶å†…è¯é‡ä¸æµ“åº¦å˜åŒ–</h3>  
                <div class="chart-container">  
                    <canvas id="hourlyMedicationChart"></canvas>  
                </div>  
            </div>  
        </div>   
        <div id="hourly-table-container" style="display:none;">  
            <h3>å‰25å°æ—¶æµ“åº¦å˜åŒ–è¡¨</h3>  
            <div class="hourly-table-container">  
                <table class="results-table hourly-table" id="hourlyTable">  
                    <thead>  
                        <tr>  
                            <th>æ—¶é—´(h)</th>  
                            <th>æµ“åº¦(pg/mL)</th>  
                            <th>æµ“åº¦(pmol/L)</th>  
                            <th>ç¬æ—¶è¯é‡(mg)</th>  
                            <th>ç´¯è®¡è¯é‡(mg)</th>  
                            <th>å¤‡æ³¨</th>  
                        </tr>  
                    </thead>  
                    <tbody id="hourlyTableBody"></tbody>  
                </table>  
            </div>  
        </div>  
  
        <div id="results-table-container" style="display:none;">  
            <h3>è¯¦ç»†æµ“åº¦æ•°æ®</h3>  
            <table class="results-table" id="resultsTable">  
                <thead>  
                    <tr>  
                        <th>æ—¶é—´ (h)</th>  
                        <th>æµ“åº¦ (pg/mL)</th>  
                        <th>æµ“åº¦ (pmol/L)</th>  
                        <th>å¤‡æ³¨</th>  
                    </tr>  
                </thead>  
                <tbody id="tableBody"></tbody>  
            </table>  
        </div>  
  
        <div class="warning-box">  
            <h4></h4> 
			<h3><strong>åŸºäº å¾·å›½ BAYER PROGYNOVAÂ® 2mg/1mg æˆŠé…¸é›ŒäºŒé†‡ åˆ†æï¼Œä¸é€‚ç”¨äºè´´ç‰‡ã€å‡èƒ¶ä¸æ³¨å°„</strong></h3>
			<h5><strong>æ­¤ä¸ºç†è®ºä¼°ç®—ï¼š</strong>æœ¬è®¡ç®—ä»…ç†è®ºè®¡ç®—è¡€è¯æµ“åº¦ï¼Œå¹¶ä¸ä»£è¡¨æ€» E2 æµ“åº¦ï¼Œä»¥å®é™…æµ‹å®šç»“æœä¸ºå‡†ï¼Œè®¡ç®—ç»“æœä»…ä½œå‚è€ƒ</li> </h5>
            <ul>  
                <li><strong>åƒè¯æ–¹å¼å¼•èµ·çš„å·®å¼‚ï¼š</strong>è¿™ä¸ªæˆ‘æ˜¯æŒ‰ç…§ç›´æ¥åƒä¸å«æœæƒ…å†µä¸‹è®¡ç®—çš„ï¼Œå¦‚æœå«æœçš„è¯ä¸€èˆ¬å³°å€¼è¡€è¯æµ“åº¦ä¼šé«˜ä¸ª2~5å€ï¼ŒåŒæ—¶ç”Ÿç‰©åˆ©ç”¨ç‡ä¹Ÿä¼šé«˜ä¸€ç‚¹</li> 
				<li>æ‰€ä»¥,å¯¹äºè¯ç‰©åˆ©ç”¨ç‡çš„è¯è¿˜æ˜¯å«æœæ¯”è¾ƒå¥½ä¸€ç‚¹ï¼Œç”±äºä¸è¿‡è‚è„ï¼Œæ€»E2ä¸è¡€è¯æµ“åº¦éƒ½æ¯”è¾ƒé«˜ã€‚ä½†æ˜¯åŒæ—¶ï¼Œè¡°å‡é€Ÿåº¦ä¹Ÿå¾ˆå¿«ï¼ŒåæœŸæµ“åº¦ä¼šæ¯”è¾ƒä½ã€‚ï¼ˆæ‰€ä»¥å…ˆæ„Ÿè§‰å¾ˆæ™•ä¹[é›Œçˆ†äº†]ï¼‰
				<li> è¿™é‡Œå£°æ˜ä¸€ä¸‹ï¼Œå¯¹äºå«æœç”Ÿç‰©åˆ©ç”¨ç‡å¹¶æ²¡æœ‰å‡†ç¡®çš„å®éªŒæ•°æ®æ¥æ”¯æŒï¼Œæˆ‘ä¹Ÿä¸æƒ³æ‹¿è‡ªå·±åšå®éªŒï¼Œæ‰€æœ‰çš„è®¡ç®—æ•°æ®æ˜¯ä¼°ç®—ã€ä¼°ç®—ã€ä¼°ç®—ï¼ï¼ï¼<li>
				
            </ul>  
		<h5>ä½œè€…/Authorï¼š<strong>@NeuroSaki987</strong>,è”ç³»æˆ‘ <strong><a href="https://t.me/NeuroSaki987">Telegram</a></strong>ï¼Œåªè¦åˆ«éª‚æˆ‘å°±è¡Œ
        </div>  
    </div>  
  
    <script>  
        let currentChart = null;  
        let hourlyMedicationChart = null;  
        let currentUnit = 'pgml';  
        let lastResults = null;  
        let isMultipleDose = false;  
        let multipleDoseData = [];   
        const MOLAR_MASS_E2 = 272.39;  
        const PG_TO_PMOL_FACTOR = 3.671; // æ¢ç®—å•ä½ 1 pg/mL = 3.671 pmol/L  
        // æ ¡å‡†æ•°æ®ï¼Œåƒä¸‡åˆ«åŠ¨ï¼Œæ‰’æ–‡çŒ®æ‰’çš„
        const CALIBRATED_SINGLE_POINTS = {  
            0.5: 6.6, 1: 12.4, 2: 21.5, 4: 32.8, 8: 39.9,   
            12: 38.3, 24: 25.3, 48: 9.5  
        };   
        function switchTab(tabName) {  
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));  
            event.target.classList.add('active');  
              
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));  
            document.getElementById(tabName === 'single' ? 'single-dose' : 'multiple-dose').classList.add('active');  
              
            hideResults();  
            isMultipleDose = (tabName === 'multiple');  
        }   
        function calculateSingleDosePK(dose, weight, bioavailability) {
			// è¯ä»£åŠ¨åŠ›å­¦è®¡ç®—æ¨¡å—ï¼Œéœ€è¦çš„å¯ä»¥è‡ªå·±æ”¹
            const V = weight * 1.0; // L, è¡¨è§‚åˆ†å¸ƒå®¹ç§¯  
            const t_half_elim = 16.9; // h, æ¶ˆé™¤åŠè¡°æœŸ  
            const k_e = Math.log(2) / t_half_elim; // hâ»Â¹, æ¶ˆé™¤é€Ÿç‡å¸¸æ•°  
            const k_a = 0.25; // hâ»Â¹, å¸æ”¶é€Ÿç‡å¸¸æ•°  
            let F;  
            if (bioavailability === 'theoretical') {  
                F = 0.04; // ç†è®ºç”Ÿç‰©åˆ©ç”¨åº¦ 4%  
            } else {  
                F = 0.0016; // æœ‰æ•ˆç”Ÿç‰©åˆ©ç”¨åº¦ 0.16%  
            }   
            const timePoints = [];  
            const concentrations = [];  
            for (let t = 0; t <= 72; t += 0.25) {  
                timePoints.push(t);  
                if (t === 0) {  
                    concentrations.push(0);  
                } else {  
                    // æ ‡å‡†ä¸€å®¤æ¨¡å‹å…¬å¼: C(t) = (F * D * ka) / (V * (ka - ke)) * (e^(-ke*t) - e^(-ka*t))  
                    const numerator = F * dose * k_a;  
                    const denominator = V * (k_a - k_e);  
                    const exponential_term = Math.exp(-k_e * t) - Math.exp(-k_a * t);  
                    const concentration_mg_L = (numerator / denominator) * exponential_term;   
                    const concentration_pg_ml = concentration_mg_L * 1000000;  
                    concentrations.push(Math.max(0, concentration_pg_ml));  
                }  
            }  
            const maxConc = Math.max(...concentrations);  
            const maxIndex = concentrations.indexOf(maxConc);  
            const tmax = timePoints[maxIndex];  
            const auc = calculateAUC(timePoints.slice(0, 100), concentrations.slice(0, 100)); // å‰25å°æ—¶AUC  
            return {  
                timePoints,  
                concentrations,  
                tmax: tmax.toFixed(1),  
                cmax: maxConc.toFixed(1),  
                auc: auc.toFixed(1),  
                type: 'single'  
            };  
        }  
		//å¤šæ¬¡ï¼Œç”¨çš„æŒ‡æ•°è¡°å‡æ‹Ÿåˆ
        function calculateMultipleDosePK(doseSchedule, weight, bioavailability) {  
            const V = weight * 1.0; // L  
            const t_half_elim = 16.9; // h  
            const k_e = Math.log(2) / t_half_elim; // h-1 
            const k_a = 0.25; // h-1
              
            let F;  
            if (bioavailability === 'theoretical') {  
                F = 0.04;
            } else {  
                F = 0.0016;
            }  
			
            const timePoints = [];  
            const concentrations = [];  
            const medicationAmounts = [];  
              
            for (let t = 0; t <= 168; t += 0.25) {
                timePoints.push(t);  
                let totalConcentration = 0;   
                doseSchedule.forEach(doseEvent => {  
                    const doseTime = doseEvent.hour;  
                    const doseAmount = doseEvent.amount;  
                    const timeSinceDose = t - doseTime;  
                      
                    if (timeSinceDose >= 0) {  
                        if (timeSinceDose === 0) { return; }  
                        const numerator = F * doseAmount * k_a;  
                        const denominator = V * (k_a - k_e);  
                        const exponential_term = Math.exp(-k_e * timeSinceDose) - Math.exp(-k_a * timeSinceDose);  
                        const concentration_mg_L = (numerator / denominator) * exponential_term;   
                        const concentration_pg_ml = concentration_mg_L * 1000000;  
                        totalConcentration += Math.max(0, concentration_pg_ml);  
                    }  
                });  
                  
                concentrations.push(totalConcentration);   
                let totalAmount = 0;  
                doseSchedule.forEach(doseEvent => {  
                    if (t >= doseEvent.hour) {  
                        const timeSinceDose = t - doseEvent.hour;   
                        const remainingFraction = Math.exp(-k_e * timeSinceDose);  
                        totalAmount += doseEvent.amount * remainingFraction * F;  
                    }  
                });  
                medicationAmounts.push(totalAmount);  
            }  
  
            const maxConc = Math.max(...concentrations);  
            const maxIndex = concentrations.indexOf(maxConc);  
            const tmax = timePoints[maxIndex];  
            const auc = calculateAUC(timePoints.slice(0, 100), concentrations.slice(0, 100));  
  
            return {  
                timePoints,  
                concentrations,  
                medicationAmounts,  
                tmax: tmax.toFixed(1),  
                cmax: maxConc.toFixed(1),  
                auc: auc.toFixed(1),  
                type: 'multiple',  
                steadyStateTime: findSteadyState(concentrations, timePoints)  
            };  
        }  
  
        function findSteadyState(concentrations, timePoints) {  
            const eliminationHalfLife = 16.9;  
            const theoreticalSteadyStateTime = eliminationHalfLife * 4;  
            let minVariation = Infinity;  
            let steadyStateTime = theoreticalSteadyStateTime;  
              
            for (let i = 0; i < timePoints.length - 20; i++) {  
                if (timePoints[i] > theoreticalSteadyStateTime) {  
                    const segment = concentrations.slice(i, i + 20);  
                    const mean = segment.reduce((a, b) => a + b, 0) / segment.length;  
                    const variation = segment.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / segment.length / mean;  
                      
                    if (variation < minVariation && variation < 0.3) {  
                        minVariation = variation;  
                        steadyStateTime = timePoints[i];  
                    }  
                }  
            }  
              
            return steadyStateTime.toFixed(1);  
        }  
  
        function calculateAUC(timePoints, concentrations) {  
            let auc = 0;  
            for (let i = 1; i < timePoints.length; i++) {  
                const dt = timePoints[i] - timePoints[i-1];  
                const avgConc = (concentrations[i-1] + concentrations[i]) / 2;  
                auc += avgConc * dt;  
            }  
            return auc;  
        }  
  
        function convertToPmol(concentrations_pgml) {  
            return concentrations_pgml.map(c => c * PG_TO_PMOL_FACTOR);  
        }  
  
        function toggleUnit(unit) {  
            currentUnit = unit;  
              
            document.getElementById('btn-pgml').classList.toggle('active', unit === 'pgml');  
            document.getElementById('btn-pmol').classList.toggle('active', unit === 'pmol');  
              
            if (lastResults) {  
                plotChart(lastResults);  
                plotHourlyMedicationChart(lastResults);  
                updateTable(lastResults);  
                updateHourlyTable(lastResults);  
            }  
        }  
  
        function addDoseTime() {  
            const container = document.getElementById('dose-schedule');  
            const count = container.children.length + 1;  
            const lastTime = container.children.length > 0 ?   
                parseFloat(container.lastElementChild.querySelector('.dose-hour').value) : 0;  
            const nextTime = Math.max(lastTime + 12, count * 24);  
              
            const div = document.createElement('div');  
            div.className = 'dose-time-input';  
            div.innerHTML = `  
                <label>ç¬¬${count}æ¬¡ç»™è¯:</label>  
                <input type="number" class="dose-hour" value="${nextTime}" min="0" max="240" step="0.5">  
                <input type="number" class="dose-amount" value="2" min="0.1" max="10" step="0.1">  
                <br><small>æ—¶é—´(h) | å‰‚é‡(mg)</small>  
                <button class="remove-dose-btn" onclick="removeDoseTime(this)">åˆ é™¤</button>  
            `;  
            container.appendChild(div);  
        }  
  
        function removeDoseTime(button) {  
            if (document.querySelectorAll('#dose-schedule .dose-time-input').length > 1) {  
                button.parentElement.remove();  
            } else {  
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªç»™è¯æ—¶é—´ï¼');  
            }  
        }  
  
        function getDoseSchedule() {  
            const inputs = document.querySelectorAll('#dose-schedule .dose-time-input');  
            const schedule = [];  
              
            inputs.forEach(input => {  
                const hour = parseFloat(input.querySelector('.dose-hour').value);  
                const amount = parseFloat(input.querySelector('.dose-amount').value);  
                if (hour >= 0 && amount > 0) {  
                    schedule.push({ hour, amount });  
                }  
            });  
              
            return schedule.sort((a, b) => a.hour - b.hour);  
        }  
  
        function calculateAndPlot() {  
            const weight = parseFloat(document.getElementById('weight').value);  
            const dose = parseFloat(document.getElementById('dose').value);  
            const bioavailability = document.getElementById('bioavailability').value;  
  
            if (!weight || !dose) {  
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä½“é‡å’Œç”¨è¯é‡ï¼');  
                return;  
            }  
  
            const results = calculateSingleDosePK(dose, weight, bioavailability);  
            lastResults = results;  
            multipleDoseData = [];  
  
            showSummary(results, weight, dose, bioavailability);  
            plotChart(results);  
            plotHourlyMedicationChart(results);  
            showResultsTable(results);  
            updateHourlyTable(results);  
        }  
  
        function calculateMultipleDoses() {  
            const weight = parseFloat(document.getElementById('multi-weight').value);  
            const bioavailability = document.getElementById('multi-bioavailability').value;  
            const dosePerTime = parseFloat(document.getElementById('dose-per-time').value);  
            const showSteadyState = document.getElementById('show-steady-state').checked;  
  
            if (!weight) {  
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä½“é‡ï¼');  
                return;  
            }  
  
            const doseSchedule = getDoseSchedule();  
            if (doseSchedule.length === 0) {  
                alert('è¯·è‡³å°‘è®¾ç½®ä¸€ä¸ªç»™è¯æ—¶é—´ï¼');  
                return;  
            }  
  
            const normalizedSchedule = doseSchedule.map(item => ({  
                hour: item.hour,  
                amount: item.amount || dosePerTime  
            }));  
  
            multipleDoseData = normalizedSchedule;  
            const results = calculateMultipleDosePK(normalizedSchedule, weight, bioavailability);  
            lastResults = results;  
  
            showSummary(results, weight, `${normalizedSchedule.length}æ¬¡ç»™è¯`, bioavailability, showSteadyState);  
            plotChart(results);  
            plotHourlyMedicationChart(results);  
            showResultsTable(results);  
            updateHourlyTable(results);  
            showDosingMarkers(normalizedSchedule);  
        }  
  
        function showDosingMarkers(doseSchedule) {  
            const markersDiv = document.getElementById('dosing-markers');  
            const times = doseSchedule.map(d => d.hour).filter(t => t <= 72);  
              
            if (times.length > 0) {  
                let markerHtml = '<strong>ç»™è¯æ—¶é—´ç‚¹:</strong><br>';  
                times.forEach((time, index) => {  
                    const amount = doseSchedule.find(d => d.hour === time)?.amount || '?';  
                    markerHtml += `â€¢ ${time}h (${amount}mg)<br>`;  
                });  
                  
                if (lastResults.steadyStateTime && lastResults.type === 'multiple') {  
                    markerHtml += `<br><strong>é¢„è®¡ç¨³æ€:</strong> ${lastResults.steadyStateTime}h`;  
                }  
                  
                markersDiv.innerHTML = markerHtml;  
                markersDiv.style.display = 'block';  
            } else {  
                markersDiv.style.display = 'none';  
            }  
        }  
  
        function plotChart(results) {  
            const ctx = document.getElementById('concentrationChart').getContext('2d');  
              
            if (currentChart) {  
                currentChart.destroy();  
            }  
  
            let concentrations = results.concentrations;  
            let yLabel = 'æµ“åº¦ (pg/mL)';  
            let dataLabel = 'E2æµ“åº¦ (pg/mL)';  
              
            if (currentUnit === 'pmol') {  
                concentrations = convertToPmol(concentrations);  
                yLabel = 'æµ“åº¦ (pmol/L)';  
                dataLabel = 'E2æµ“åº¦ (pmol/L)';  
            }  

            const gradient = ctx.createLinearGradient(0, 0, 0, 500);  
            gradient.addColorStop(0, 'rgba(85, 205, 252, 0.3)');  
            gradient.addColorStop(1, 'rgba(85, 205, 252, 0.05)');  
            currentChart = new Chart(ctx, {  
                type: 'line',  
                data: {  
                    labels: results.timePoints,  
                    datasets: [{  
                        label: dataLabel,  
                        data: concentrations,  
                        borderColor: '#55CDFC',  
                        backgroundColor: gradient,  
                        borderWidth: 3,  
                        fill: true,  
                        tension: 0.1,  
                        pointRadius: 0,  
                        pointHoverRadius: 4  
                    }]  
                },  
                options: {  
                    responsive: true,  
                    maintainAspectRatio: false,  
                    plugins: {  
                        title: {  
                            display: true,  
                            text: 'é›ŒäºŒé†‡(E2)è¡€è¯æµ“åº¦-æ—¶é—´æ›²çº¿',  
                            font: { size: 14, weight: 'bold' }  
                        },  
                        legend: {  
                            display: true,  
                            position: 'top'  
                        },  
                        tooltip: {  
                            mode: 'index',  
                            intersect: false,  
                            callbacks: {  
                                title: function(context) {  
                                    return `æ—¶é—´: ${context[0].label} h`;  
                                },  
                                label: function(context) {  
                                    const unit = currentUnit === 'pgml' ? 'pg/mL' : 'pmol/L';  
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} ${unit}`;  
                                }  
                            }  
                        }  
                    },  
                    scales: {  
                        x: {  
                            display: true,  
                            title: {  
                                display: true,  
                                text: 'æ—¶é—´ (å°æ—¶)',  
                                font: { weight: 'bold' }  
                            },  
                            grid: {  
                                color: 'rgba(0,0,0,0.1)',  
                                lineWidth: 1  
                            },  
                            ticks: {  
                                maxTicksLimit: 20  
                            }  
                        },  
                        y: {  
                            display: true,  
                            title: {  
                                display: true,  
                                text: yLabel,  
                                font: { weight: 'bold' }  
                            },  
                            beginAtZero: true,  
                            grid: {  
                                color: 'rgba(0,0,0,0.1)',  
                                lineWidth: 1  
                            }  
                        }  
                    },  
                    interaction: {  
                        intersect: false,  
                        mode: 'index'  
                    }  
                }  
            });  
        }
  
        function plotHourlyMedicationChart(results) {  
            const ctx = document.getElementById('hourlyMedicationChart').getContext('2d');  
              
            if (hourlyMedicationChart) {  
                hourlyMedicationChart.destroy();  
            }  
            const endIndex = Math.min(100, results.timePoints.length);  
            const hourlyTimes = results.timePoints.slice(0, endIndex);  
            let hourlyConcentrations = results.concentrations.slice(0, endIndex);  
            let hourlyMedication = results.medicationAmounts ?   
                results.medicationAmounts.slice(0, endIndex) : new Array(endIndex).fill(0);  
  
            let concLabel = 'E2æµ“åº¦ (pg/mL)';  
            let medLabel = 'ä¼°ç®—è¯é‡ (mg)';  
              
            if (currentUnit === 'pmol') {  
                hourlyConcentrations = convertToPmol(hourlyConcentrations);  
                concLabel = 'E2æµ“åº¦ (pmol/L)';  
            }  
  
            hourlyMedicationChart = new Chart(ctx, {  
                type: 'line',  
                data: {  
                    labels: hourlyTimes,  
                    datasets: [  
                        {  
                            label: concLabel,  
                            data: hourlyConcentrations,  
                            borderColor: '#55CDFC',  
                            backgroundColor: 'rgba(0, 204, 255, 0.1)',  
                            borderWidth: 2,  
                            fill: false,  
                            tension: 0.1,  
                            yAxisID: 'y'  
                        },  
                        {  
                            label: medLabel,  
                            data: hourlyMedication,  
                            borderColor: '#FFB6C1',  
                            backgroundColor: 'rgba(255, 182, 193, 0.1)',  
                            borderWidth: 2,  
                            fill: false,  
                            tension: 0.1,  
                            yAxisID: 'y1'  
                        }  
                    ]  
                },  
                options: {  
                    responsive: true,  
                    maintainAspectRatio: false,  
                    plugins: {  
                        title: {  
                            display: true,  
                            text: '25å°æ—¶å†…æµ“åº¦ä¸è¯é‡å˜åŒ–è¶‹åŠ¿',  
                            font: { size: 14, weight: 'bold' }  
                        },  
                        legend: {  
                            display: true,  
                            position: 'top'  
                        }  
                    },  
                    scales: {  
                        x: {  
                            display: true,  
                            title: {  
                                display: true,  
                                text: 'æ—¶é—´ (å°æ—¶)',  
                                font: { weight: 'bold' }  
                            },  
                            grid: {  
                                color: 'rgba(0,0,0,0.1)'  
                            },  
                            ticks: {  
                                maxTicksLimit: 15  
                            }  
                        },  
                        y: {  
                            type: 'linear',  
                            display: true,  
                            position: 'left',  
                            title: {  
                                display: true,  
                                text: concLabel,  
                                font: { weight: 'bold' },  
                                color: '#55CDFC'  
                            },  
                            grid: {  
                                color: 'rgba(0,0,0,0.1)'  
                            },  
                            ticks: {  
                                color: '#55CDFC'  
                            }  
                        },  
                        y1: {  
                            type: 'linear',  
                            display: true,  
                            position: 'right',  
                            title: {  
                                display: true,  
                                text: medLabel,  
                                font: { weight: 'bold' },  
                                color: '#FFB6C1'  
                            },  
                            grid: {  
                                drawOnChartArea: false,  
                            },  
                            ticks: {  
                                color: '#FFB6C1'  
                            }  
                        }  
                    },  
                    interaction: {  
                        intersect: false,  
                        mode: 'index'  
                    }  
                }  
            });  
        }  
  
        function showSummary(results, weight, doseInfo, bioavailability, showSteadyState = false) {  
            const summaryDiv = document.getElementById('summary');  
            const contentDiv = document.getElementById('summary-content');  
            const titleDiv = document.getElementById('summary-title');  
              
            const modelName = bioavailability === 'theoretical' ? 'ç†è®ºæ¨¡å‹' : 'æ ¡å‡†æ¨¡å‹';  
            const modelDesc = bioavailability === 'theoretical' ?   
                'ä½¿ç”¨F=4%çš„ç†è®ºç”Ÿç‰©åˆ©ç”¨åº¦' : 'ä½¿ç”¨F=0.16%çš„æœ‰æ•ˆç”Ÿç‰©åˆ©ç”¨åº¦(åŒ¹é…æ–‡çŒ®Cmaxâ‰ˆ40pg/mL)';  
              
            let summaryHTML = `  
                <p><strong>ä½“é‡:</strong> ${weight} kg | <strong>ç»™è¯æ–¹æ¡ˆ:</strong> ${doseInfo}</p>  
                <p><strong>æ¨¡å‹:</strong> ${modelName} (${modelDesc})</p>  
                <p><strong>è¾¾å³°æ—¶é—´ (Tmax):</strong> ${results.tmax} å°æ—¶</p>  
                <p><strong>å³°æµ“åº¦ (Cmax):</strong> ${results.cmax} pg/mL (${ (results.cmax * PG_TO_PMOL_FACTOR).toFixed(1) } pmol/L)</p>  
                <p><strong>å‰25å°æ—¶AUC:</strong> ${parseFloat(results.auc).toLocaleString()} pgÂ·h/mL</p>  
                <p><strong>è¡¨è§‚åˆ†å¸ƒå®¹ç§¯:</strong> ${(weight * 1.0).toFixed(1)} L</p>  
                <p><strong>æ¶ˆé™¤åŠè¡°æœŸ:</strong> 16.9 å°æ—¶</p>   
            `;  
              
            if (showSteadyState && results.type === 'multiple' && results.steadyStateTime) {  
                summaryHTML += `<p><strong>é¢„è®¡ç¨³æ€æ—¶é—´:</strong> ${results.steadyStateTime} å°æ—¶ (çº¦${(results.steadyStateTime/24).toFixed(1)}å¤©)</p>`;  
            }  
              
            contentDiv.innerHTML = summaryHTML;  
            titleDiv.textContent = results.type === 'multiple' ? 'å¤šæ¬¡ç»™è¯è®¡ç®—' : 'å•æ¬¡ç»™è¯è®¡ç®—';  
            summaryDiv.style.display = 'block';  
        }  
  
        function hideResults() {  
            document.getElementById('summary').style.display = 'none';  
            document.getElementById('results-table-container').style.display = 'none';  
            document.getElementById('hourly-table-container').style.display = 'none';  
            document.getElementById('dosing-markers').style.display = 'none';  
              
            if (currentChart) {  
                currentChart.destroy();  
                currentChart = null;  
            }  
            if (hourlyMedicationChart) {  
                hourlyMedicationChart.destroy();  
                hourlyMedicationChart = null;  
            }  
        }  
  
        function showResultsTable(results) {  
            const container = document.getElementById('results-table-container');  
            const tableBody = document.getElementById('tableBody');  
            tableBody.innerHTML = '';   
            const keyTimes = [0, 0.5, 1, 2, 4, 6, 8, 10, 12, 16, 24, 36, 48, 60, 72];  
            keyTimes.forEach(time => {  
                const index = results.timePoints.findIndex(t => Math.abs(t - time) < 0.15);  
                if (index !== -1) {  
                    const conc_pgml = results.concentrations[index];  
                    const conc_pmol = conc_pgml * PG_TO_PMOL_FACTOR;  
                      
                    let note = '';  
                    if (Math.abs(time - parseFloat(results.tmax)) < 0.5) {  
                        note = 'â† Tmax';  
                    } else if (time === 0) {  
                        note = 'ç»™è¯æ—¶åˆ»';  
                    }  
                    const row = tableBody.insertRow();  
                    row.innerHTML = `  
                        <td>${time}</td>  
                        <td>${conc_pgml.toFixed(1)}</td>  
                        <td>${conc_pmol.toFixed(1)}</td>  
                        <td>${note}</td>  
                    `;  
                }  
            });  
              
            container.style.display = 'block';  
        }  
  
        function updateHourlyTable(results) {  
            const container = document.getElementById('hourly-table-container');  
            const tableBody = document.getElementById('hourlyTableBody');  
            tableBody.innerHTML = '';  
            const displayInterval = 4; 
            for (let i = 0; i < Math.min(100, results.timePoints.length); i += displayInterval) {  
                const time = results.timePoints[i];  
                const conc_pgml = results.concentrations[i];  
                const conc_pmol = conc_pgml * PG_TO_PMOL_FACTOR;  
                const med_amount = results.medicationAmounts ? results.medicationAmounts[i] : 0;  
                let note = '';  
                if (Math.abs(time - parseFloat(results.tmax)) < 0.5) {  
                    note = 'â† Tmax';  
                } else if (i === 0) {  
                    note = 'ç»™è¯æ—¶åˆ»';  
                } else if (isMultipleDose && multipleDoseData.some(d => Math.abs(d.hour - time) < 0.5)) {  
                    const dose = multipleDoseData.find(d => Math.abs(d.hour - time) < 0.5);  
                    note = `ç»™è¯ +${dose.amount}mg`;  
                }  
                const row = tableBody.insertRow();  
                row.innerHTML = `  
                    <td>${time.toFixed(2)}</td>  
                    <td>${conc_pgml.toFixed(2)}</td>  
                    <td>${conc_pmol.toFixed(2)}</td>  
                    <td>${med_amount.toFixed(3)}</td>  
                    <td>${med_amount.toFixed(1)}</td>  
                    <td>${note}</td>  
                `;  
            }  
            container.style.display = 'block';  
        }  
        function updateTable(results) {  
            showResultsTable(results);  
            if (results.timePoints.length > 0) {  
                updateHourlyTable(results);  
            }  
        }  
        window.onload = function() {  
            calculateAndPlot();  
        };  
    </script>  
</body>  
</html>  
